function formatDate(e,t){var n=e.getDate(),r=e.getMonth()+1,i=e.getFullYear();if(n<10){n="0"+n}if(r<10){r="0"+r}var s=r+"/"+n+"/"+i;var o=i+"-"+r+"-"+n;if(t==="display"){return s}else{return o}}function onDOMLoad(){$(document).ready(function(){jQueryReady;$.mobile.showPageLoadingMsg();$("#obsForm").validate();$("#avyObsForm").validate();$("#stabTestForm").validate()});$("#dateLabel").html("NWAC Mobile");$(".number").bind("keypress",function(e){var t=new RegExp("^[0-9]+(\.[0-9]{1,2})?$");var n=String.fromCharCode(!e.charCode?e.which:e.charCode);if(!t.test(n)){e.preventDefault();return false}});$(document).delegate("#mapPage","pageshow",function(){resizeMap()});dojo.connect(window,"onUnload",$.mobile.changePage("#mapPage"));$("form").bind("submit",function(e){e.preventDefault();var t=$(this);var n=$(this).attr("name");console.log(n);$.mobile.showPageLoadingMsg();if(n==="stabTestForm"){if($(this).valid()){var r=lastObsAdded;console.log("obs ID: ",r);var i=true;console.log("submitting stab test");var s="{";var o=t.serializeArray();o.forEach(function(e){console.log(e.value);if(e.value){switch(e.value){case"":console.log(e.value);case null:console.log(e.value);default:console.log(e.value);i=false}}});console.log(i);if(i===false){o.forEach(function(e){console.log(e.value);complete=true;if(e.name==="shear_depth"){console.log("it does...",e.name,e.value);s+='"'+e.name+'": '+e.value+","}else if(e.name==="shear_quality"){if(e.value){console.log("it does...",e.name,e.value);s+='"'+e.name+'": '+e.value+","}}else{console.log("it does not");s+='"'+e.name+'": "'+e.value+'",'}});s+='"observation": "/api/v1/observation/'+r+'/"}';$.ajax({url:proxyUrl+"?"+t.attr("action"),data:s,contentType:"application/json",dataType:"json",type:"POST",success:function(e){stabTestFormResponse(e,t)},error:function(e){stabFormReturn(e,t)}})}else{$.mobile.hidePageLoadingMsg();alert("At least one field must be entered")}}else{$.mobile.hidePageLoadingMsg();alert("Please fill out required fields")}}else{if(n==="obsForm"){if($("#id_snowpit_profile_image_url").val().length>0&&$("#id_snowpit_profile_image_url").val().substr(0,7)!=="http://"){$("#id_snowpit_profile_image_url").val("http://"+$("#id_snowpit_profile_image_url").val());$(this).validate({rules:{url:true}})}else{console.log("no url entered...")}console.log($(this).valid());if($(this).valid()){submitForm(t)}else{$.mobile.hidePageLoadingMsg();alert("Please fill out required fields")}}}});init()}function submitForm(e){var t=new FormData;e.serializeArray().forEach(function(e){switch(e.name){case"datetime":var n=new Date(e.value);e.value=formatDate(n,"obs")+" 12:00";t.append(e.name,e.value);break}t.append(e.name,e.value)});t.append("location-region",zone);$.each($(":file"),function(e){var n=this.files[0];var r=$(this).attr("name");if(!n){}else{console.log($(this),r,n,$(this).attr("files"));t.append(r,n)}});$.ajax({url:proxyUrl+"?"+e.attr("action"),data:t,cache:false,contentType:false,processData:false,type:"POST",success:function(t){formResponse(t,e)},error:function(e){formFail(e)}})}function stabFormReturn(e,t){$.mobile.hidePageLoadingMsg();var n=JSON.stringify(e,null,2);var r=$.parseJSON(n).statusText;console.log(e,r);if(r==="OK"){$("#stabTestDivLabel").html("Add another stability test?");$.mobile.changePage("#mapPage");resetForms(t)}else{alert("Oops, error submitting stability test")}}function formFail(e){$.mobile.hidePageLoadingMsg();alert("Oops, error adding your observation");console.log(e)}function stabTestFormResponse(e){$("#stabTestDivLabel").html("Add another stability test?");$.mobile.changePage("#mapPage");resetForms(form)}function formResponse(e,t){$.mobile.hidePageLoadingMsg();var n=JSON.stringify(e,null,2);var r=$.parseJSON(n).id;lastObsAdded=r;var i;var s=new esri.symbol.SimpleMarkerSymbol;switch(addObType){case"addObByClick"||"addObByGeoloc":s.setColor(new dojo.Color([0,153,255,.5]));i=map.getLayer("obsLayer");console.log("Ob",i);!obsGotten?null:getSingleObs("observation",r,s,i);askAddStabTest();break;case"addAvyObByClick"||"addAvyObByGeoloc":s.setColor(new dojo.Color([153,51,255,.5]));i=map.getLayer("avyObsLayer");console.log("avyOb",i);!avyObsGotten?null:getSingleObs("avalancheObservation",r,s,i);break}map.graphics.hide();hideAskFillOutForm();updateGraphicHandles();resetForms(t);$.mobile.changePage("#mapPage")}function getSingleObs(e,t,n,r){var i="http://www.nwac.us/api/v1/"+e+"/"+t;console.log(e,t,n,r,i);var s=esri.request({url:i,content:{format:"json"},handleAs:"json"});s.then(function(e){console.log(e);appendOb(r,e,n)},requestFailed)}function appendOb(e,t,n){var r=esri.geometry.geographicToWebMercator(new esri.geometry.Point(t.location.longitude,t.location.latitude));var i=new esri.Graphic(r,n,t);e.add(i)}function resetForms(e){console.log(e[0]);e[0].reset();$.each($(":checkbox"),function(e){var t=$(this).attr("name");$("input[name="+t+"]").attr("checked",false).checkboxradio("refresh")});e.find("select").val("").selectmenu("refresh",true);console.log(e.attr("name"));e.attr("name")==="obsForm"?$("#obs_location-elevation_units").val("feet").selectmenu("refresh",true):null;e.attr("name")==="avyObsForm"?$("#avy_location-elevation_units").val("feet").selectmenu("refresh",true):null}function init(){esri.config.defaults.io.proxyUrl=proxyUrl="http://140.160.114.190/proxy/proxy.ashx";esri.config.defaults.io.alwaysUseProxy=false;esri.config.defaults.map.slider={top:"100px"};initExtent=new esri.geometry.Extent(-13937126,5280024,-13154411,6454097,new esri.SpatialReference({wkid:102100}));map=new esri.Map("map",{extent:initExtent,logo:false,wrapAround180:true,fadeOnZoom:true,force3DTransforms:true,navigationMode:"css-transforms"});map.disableMapNavigation();map.hideZoomSlider();var e=new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer");map.addLayer(e);createBasemapGallery();locator=new esri.tasks.Locator("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Locators/ESRI_Geocode_USA/GeocodeServer");map.infoWindow.resize(185,100);var t="onorientationchange"in window,n=t?"orientationchange":"resize";window.addEventListener(n,function(){orientationChanged()},false);dojo.connect(map,"onLoad",function(){resizeMap();$.mobile.hidePageLoadingMsg()});addDangerOverlay();$("#header").bind("tap",function(e){_show(e)});$("#map").bind("tap",function(){_hide()});checkZoom=dojo.connect(map,"onZoomEnd",function(e){checkShowZoomAlert()});currentLocSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,12,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([210,150,50,.5]),8),new dojo.Color([210,150,50,.9]));avyObsSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,12,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([153,51,255,.5]),8),new dojo.Color([153,51,255,.9]));obsSymbol=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,12,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,153,255,.5]),8),new dojo.Color([0,153,255,.9]));highlighted=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,20,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0]),2),new dojo.Color([245,7,189,.5]));addPageSwipeListeners("#obsAttsPage");dojo.connect(map,"onLoad",addGraphic)}function showCalendar(e){$thisCalendar=$(e).attr("id");$("#"+$thisCalendar+"Date").datebox("open")}function changeDates(e){datesChanged=true;var t=$(e).attr("id");var n=$(e).val();if(t==="fromDate"){prevFromDate=n}else{prevToDate=n}if($("#obsFlip")[0].selectedIndex===1){obsGotten=false;map.getLayer("obsLayer").clear();$("#obsFlip")[0].selectedIndex=0;$("#obsFlip").slider("refresh")}if($("#avyObsFlip")[0].selectedIndex===1){avyObsGotten=false;map.getLayer("avyObsLayer").clear();$("#avyObsFlip")[0].selectedIndex=0;$("#avyObsFlip").slider("refresh")}hideGoToAttsDiv()}function show_hideObs(e){$.mobile.showPageLoadingMsg();if(e==="showObs"){!addGraphicHandle?null:removeAddGraphicHandles();if(!obsGotten){getObs("observation")}else{map.getLayer("obsLayer").show();showObsAttsHandle=dojo.connect(map.getLayer("obsLayer"),"onClick",showAttributes);$.mobile.hidePageLoadingMsg()}}else if(e==="showAvyObs"){!addGraphicHandle?null:removeAddGraphicHandles();if(!avyObsGotten){getObs("avalancheObservation")}else{map.getLayer("avyObsLayer").show();showAvyObsAttsHandle=dojo.connect(map.getLayer("avObsLayer"),"onClick",showAttributes);$.mobile.hidePageLoadingMsg()}}else if(e==="hideObs"){!map.getLayer("obsLayer")?null:map.getLayer("obsLayer").hide();$.mobile.hidePageLoadingMsg()}else if(e==="hideAvyObs"){!map.getLayer("avyObsLayer")?null:map.getLayer("avyObsLayer").hide();$.mobile.hidePageLoadingMsg()}}function removeAddGraphicHandles(){dojo.disconnect(addGraphicHandle);!addObType?null:graphic.setSymbol(null);addObType=null;addGraphicHandle=null}function getObs(e){type=e;var t=new Date((new Date(prevToDate)).getTime()+ONE_DAY);var n="http://www.nwac.us/api/v1/"+type+"/";var r=esri.request({url:n,content:{format:"json",datetime__gte:formatDate(new Date(prevFromDate),"obs"),datetime__lte:formatDate(t,"obs"),time:(new Date).getTime()},handleAs:"json"});type==="observation"?r.then(obsRequestSucceeded,requestFailed):r.then(avyObsRequestSucceeded,requestFailed);datesChanged=false}function obsRequestSucceeded(e){var t=JSON.stringify(e,null,2);var n=$.parseJSON(t);addObsLayer(n)}function avyObsRequestSucceeded(e){var t=JSON.stringify(e,null,2);var n=$.parseJSON(t);addAvyObsLayer(n)}function requestFailed(e){console.log("Error: ",e.message)}function addObsLayer(e){var t=new esri.symbol.SimpleMarkerSymbol;var n=new esri.layers.GraphicsLayer;t.setColor(new dojo.Color([0,153,255,.5]));n.id="obsLayer";obsGotten=true;map.addLayer(n);dojo.forEach(e.objects,function(e){var r=esri.geometry.geographicToWebMercator(new esri.geometry.Point(e.location.longitude,e.location.latitude));var i=new esri.Graphic(r,t,e);n.add(i)});showObsAttsHandle=dojo.connect(n,"onClick",showAttributes);n.show();map.reorderLayer(n,1);$.mobile.hidePageLoadingMsg()}function addAvyObsLayer(e){var t=new esri.symbol.SimpleMarkerSymbol;var n=new esri.layers.GraphicsLayer;t.setColor(new dojo.Color([153,51,255,.5]));n.id="avyObsLayer";avyObsGotten=true;map.addLayer(n);dojo.forEach(e.objects,function(e){var r=esri.geometry.geographicToWebMercator(new esri.geometry.Point(e.location.longitude,e.location.latitude));var i=new esri.Graphic(r,t,e);n.add(i)});showAvyObsAttsHandle=dojo.connect(n,"onClick",showAttributes);n.show();map.reorderLayer(n,1);$.mobile.hidePageLoadingMsg()}function getStabTest(e,t){console.log("getting stabTest...");var n=e.attributes.id;var r="http://www.nwac.us/api/v1/stabilityTest/";var i=esri.request({url:r,content:{format:"json",observation:n,time:(new Date).getTime()},handleAs:"json"});i.then(function(n){stabTestRequestSucceeded(n,e,t)},requestFailed)}function stabTestRequestSucceeded(e,t,n){console.log(e.objects);var r=JSON.stringify(e,null,2);var i=$.parseJSON(r);if(i.objects){$.each(i.objects,function(e,t){console.log(e,t);markup+="<li data-role='list-divider' data-theme='a'>"+"Stability Test "+(e+1)+"</li>";t.test_type!==""&&t.test_type!==null?addToMarkup("Shear quality",t.test_type):null;t.failure_load!==""&&t.failure_load!==null?addToMarkup("Shear quality",t.failure_load):null;t.shear_depth!==""&&t.shear_depth!==null?addToMarkup("Depth of shear",t.shear_depth+" "+t.shear_depth_units):null;t.shear_quality!==""&&t.shear_quality!==null?addToMarkup("Shear quality","Q"+t.shear_quality):null;t.observations_comments!==""&&t.observations_comments!==null?addToMarkup("Test comments",t.observations_comments):null})}else{console.log("no parsed.objects")}makePage(t,n)}function getElevation(e,t){var n="http://open.mapquestapi.com/elevation/v1/profile?shapeFormat=raw&unit=f&latLngCollection="+e+","+t;var r=esri.request({url:n,content:{},handleAs:"json"});r.then(elevRequestSucceeded,requestFailed)}function elevRequestSucceeded(e){var t=JSON.stringify(e.elevationProfile[0],null,2);var n=$.parseJSON(t);var r=Number(n.height).toFixed(0);$("#obs_location-elevation").val(r);$("#avy_location-elevation").val(r);console.log(r)}function createBasemapGallery(){var e=[],t,n,r,i,s;t=new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer"})],id:"topo",title:"Topo"});n=new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"})],id:"streets",title:"Streets"});r=new esri.dijit.Basemap({layers:[new esri.dijit.BasemapLayer({url:"http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer"})],id:"imagery",title:"Imagery"});e.push(t);e.push(n);e.push(r);basemapGallery=new esri.dijit.BasemapGallery({showArcGISBasemaps:false,basemaps:e,map:map});basemapGallery.startup();dojo.connect(basemapGallery,"onError",function(e){console.log(e)})}function changeBasemap(e){basemapGallery.select(e);$("#basemapSelect").selectmenu("refresh",true)}function hideInfoDiv(){$("#infoDiv").remove();checkHideButton();resizeMap();dojo.connect(map,"onLoad",function(){map.enableMapNavigation();map.showZoomSlider()})}function checkShowZoomAlert(){if(map.getScale()<=72223.819286){$.mobile.changePage("#zoomAlert",{changeHash:false});dojo.disconnect(checkZoom)}}function _show(e){if(e.target.id=="header"||e.target.id=="dateLabel"){$("#header").unbind("tap",function(){_show()});$("#toolbar").css({visibility:"visible",display:"block"})}else{}}function _hide(){$("#header").bind("tap",function(e){_show(e)});$("#toolbar").hide(500).css({visibility:"hidden",display:""})}function addDangerOverlay(){day1Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day1/MapServer",{opacity:.4,visible:false});day2Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day2/MapServer",{opacity:.4,visible:false});day3Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day3/MapServer",{opacity:.4,visible:false});day4Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day4/MapServer",{opacity:.4,visible:false});day5Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day5/MapServer",{opacity:.4,visible:false});day6Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day6/MapServer",{opacity:.4,visible:false});day7Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day7/MapServer",{opacity:.4,visible:false});day8Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day8/MapServer",{opacity:.4,visible:false});day9Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day9/MapServer",{opacity:.4,visible:false});day10Layer=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/arcgis/rest/services/NWAC/Day10/MapServer",{opacity:.4,visible:false});dayLayerList=[day1Layer,day2Layer,day3Layer,day4Layer,day5Layer,day6Layer,day7Layer,day8Layer,day9Layer,day10Layer];RegionsBoth=new esri.layers.ArcGISTiledMapServiceLayer("http://140.160.114.190/ArcGIS/rest/services/NWAC/RegionsBoth/MapServer",{opacity:.55});buildRegionQuery();var e=0;var t="http://140.160.114.190/nwac/forecastxml2.xml?="+todayVar;xmlDoc=loadXMLDoc(t);var n=xmlDoc.getElementsByTagName("date");var r=xmlDoc.getElementsByTagName("zones");var i=(new Date).getTime();for(var s=0;s<n.length;s++){var o=(new Date(n[s].childNodes[0].nodeValue)).getTime();var u=Math.round(Math.abs(i-o)/ONE_DAY);if(u<30){dateList.push(n[s].childNodes[0].nodeValue)}else{}}for(var a=0;a<13;a++){day1RoseList.push(r[0].childNodes[a].childNodes[0].nodeValue);day2RoseList.push(r[1].childNodes[a].childNodes[0].nodeValue);day3RoseList.push(r[2].childNodes[a].childNodes[0].nodeValue);day4RoseList.push(r[3].childNodes[a].childNodes[0].nodeValue);day5RoseList.push(r[4].childNodes[a].childNodes[0].nodeValue);day6RoseList.push(r[5].childNodes[a].childNodes[0].nodeValue);day7RoseList.push(r[6].childNodes[a].childNodes[0].nodeValue);day8RoseList.push(r[7].childNodes[a].childNodes[0].nodeValue);day9RoseList.push(r[8].childNodes[a].childNodes[0].nodeValue);day10RoseList.push(r[9].childNodes[a].childNodes[0].nodeValue)}for(var f=0;f<10;f++){dayChangerArray.push({id:f,layer:dayLayerList[f],roseArray:dayRoseListArray[f]})}if(dateList.length>0){if(today===dateList[0]){startLayer=dayLayerList[0];selectedDay=0}else if(today===dateList[1]){startLayer=dayLayerList[1];selectedDay=1}else if(today===dateList[2]){startLayer=dayLayerList[2];selectedDay=2}else{startLayer=dayLayerList[0];selectedDay=0}document.getElementById("dateLabel").innerHTML=dateList[selectedDay];dojo.connect(map,"onLoad",function(e){for(var t=0;t<dateList.length;t++){map.addLayer(dayLayerList[t])}startLayer.show();map.addLayer(RegionsBoth)});$("#header").swipeleft(function(){plusDay()});$("#header").swiperight(function(){minusDay()})}else{document.getElementById("dateLabel").innerHTML="No recent forecasts";map.addLayer(RegionsBoth);$("#minusDayBtn").remove();$("#plusDayBtn").remove()}setDatePicker()}function setDate(e){$(e).trigger("datebox",{method:"set",value:today,date:new Date}).trigger("datebox",{method:"doset"});console.log(e,$(e).val());e==="#avy_Date"?$("#avy_").html(today+"  Click to change"):$("#obs_").html(today+"  Click to change")}function addPageSwipeListeners(e){$(e).swipeleft(function(){$.mobile.changePage("#mapPage",{changeHash:false,transition:"slide"})});$(e).swiperight(function(){$.mobile.changePage("#mapPage",{changeHash:false,transition:"slide",reverse:true})})}function setDatePicker(){prevToDate=today;prevFromDate=formatDate(new Date((new Date(prevToDate)).getTime()-10*ONE_DAY),"display");$("#from").html("From:  "+prevFromDate);$("#to").html("To:  "+prevToDate);$("#fromDate").live("change",function(){var e=new Date,t=parseInt(($("#fromDate").data("datebox").theDate-e)/(1e3*60*60*24));diffstrt=t*-1-1;$("#toDate").data("datebox").options.minDays=diffstrt;var n=Math.round(((new Date($("#fromDate").val())).getTime()-(new Date($("#toDate").val())).getTime())/ONE_DAY);if(n>0){console.log("from is before to");var r=formatDate(new Date((new Date($("#fromDate").val())).getTime()+ONE_DAY),"display");$("#toDate").val(r);$("#to").html("To:  "+$("#toDate").val());prevToDate=r}});$("#avy_datetime").live("change",function(){console.log("changed...")})}function plusDay(){if(selectedDay!=0){selectedDay-=1;changeDay()}else{console.log("already at day 1")}}function minusDay(){if(selectedDay!=dateList.length-1){selectedDay+=1;changeDay()}else{console.log("already at day 10")}}function changeDay(){selLayer=dayLayerList[selectedDay];for(var e=0;e<dateList.length;e++){var t=dayLayerList[e];t.hide();t===selLayer?t.show():t.hide();roseList[selectedDay]=dayRoseListArray[selectedDay][e]}selLayer.show();document.getElementById("dateLabel").innerHTML=dateList[selectedDay];checkHideButton()}function checkHideButton(){var e=document.getElementById("minusDayBtn");var t=document.getElementById("plusDayBtn");e.style.visibility=selectedDay!=dateList.length-1?"visible":"hidden";t.style.visibility=selectedDay!=0?"visible":"hidden"}function getLocation(){if(navigator.geolocation){console.log("got location...");watchId=navigator.geolocation.watchPosition(showLocation,locationError);console.log(watchId)}}function locationError(e){if(navigator.geolocation){navigator.geolocation.clearWatch(watchId)}switch(e.code){case e.PERMISSION_DENIED:alert("Your location couldn't be determined...Check your browser settings to make sure location services are allowed for this site.");console.log("Location not provided");break;case e.POSITION_UNAVAILABLE:alert("Your location couldn't be determined...Check your browser settings to make sure location services are allowed for this site.");console.log("Current location not available");break;case e.TIMEOUT:alert("Location request timed out");console.log("Timeout");break;default:alert("Error getting location");console.log("unknown error");break}}function zoomToLocation(e){var t=esri.geometry.geographicToWebMercator(new esri.geometry.Point(e.coords.longitude,e.coords.latitude));getLatLongThenGetElev(t);map.centerAndZoom(t,16)}function setLongLatInForms(e,t){$("#obs_location-latitude").val(e);$("#obs_location-longitude").val(t);$("#avy_location-latitude").val(e);$("#avy_location-longitude").val(t);console.log(e,t)}function showLocation(e){console.log("showing location...");if(!addGraphicHandle){}else if(addGraphicHandle.length>0){removeAddGraphicHandles()}var t=esri.geometry.geographicToWebMercator(new esri.geometry.Point(e.coords.longitude,e.coords.latitude));graphic.setSymbol(getSymbol());graphic.setGeometry(t);map.graphics.show();zoomToLocation(e);navigator.geolocation.clearWatch(watchId)}function addGraphic(){var e=esri.geometry.geographicToWebMercator(new esri.geometry.Point(0,90));graphic=new esri.Graphic(e,getSymbol());map.graphics.add(graphic);map.graphics.hide();console.log("make and hide graphic")}function getLatLongThenGetElev(e){var t=esri.geometry.webMercatorToGeographic(e);var n=t.y.toFixed(6);var r=t.x.toFixed(6);console.log(n,r);getElevation(n,r);setLongLatInForms(n,r)}function addGraphicClick(e){map.graphics.show();graphic.setSymbol(getSymbol());graphic.setGeometry(e.mapPoint);getLatLongThenGetElev(e.mapPoint);askFillOutForm()}function startAddOb(e){!addGraphicHandle?null:removeAddGraphicHandles();addObType=e;getSymbol();showObsAttsHandle?dojo.disconnect(showObsAttsHandle):null;showAvyObsAttsHandle?dojo.disconnect(showAvyObsAttsHandle):null;if(e!=="addAvyObByGeoLoc"&&e!=="addObByGeoLoc"){addGraphicHandle=dojo.connect(map,"onClick",addGraphicClick)}else{getLocation();askFillOutForm()}$.mobile.changePage("#mapPage");$("#addAvyObSelect option")[0].selected=true;$("#addObSelect option")[0].selected=true;$("#addObSelect").selectmenu("refresh",true);$("#addAvyObSelect").selectmenu("refresh",true);if(e==="addObByGeoLoc"||e==="addObByClick"){$("#changeReportSlider")[0].selectedIndex=0}else{$("#changeReportSlider")[0].selectedIndex=1}$("#changeReportSlider").slider("refresh");addObType!==null?changeObs(e):null}function getSymbol(){if(!addObType){symbol=currentLocSymbol;console.log("currentLocSymbol...")}else if(addObType==="addAvyObByClick"||addObType==="addAvyObByGeoLoc"){symbol=avyObsSymbol}else{symbol=obsSymbol}return symbol}function jQueryReady(){$("#mapPage").bind("pageshow",function(e,t){resizeMap()})}function orientationChanged(){if(map){resizeMap()}}function resizeMap(){if(map){$("#map").css("height",screen.height);$("#map").css("width","auto");map.reposition();map.resize()}}function bookmarkSelect_changeHandler(e){console.log(e);var t=new esri.geometry.Extent(-13851e3,6045e3,-13687e3,605e4,new esri.SpatialReference({wkid:102100}));var n=new esri.geometry.Extent(-13592300,5638300,-13510300,5710600,new esri.SpatialReference({wkid:102100}));var r=new esri.geometry.Extent(-13503992,6024773,-13455073,6098152,new esri.SpatialReference({wkid:102100}));var i=new esri.geometry.Extent(-13542712,5957299,-13493793,6030678,new esri.SpatialReference({wkid:102100}));var s=new esri.geometry.Extent(-13536249,5830776,-13487329,5904155,new esri.SpatialReference({wkid:102100}));var o=new esri.geometry.Extent(-13603953,5988709,-13408275,6282227,new esri.SpatialReference({wkid:102100}));var u=new esri.geometry.Extent(-13655625,5750225,-13459946,6043743,new esri.SpatialReference({wkid:102100}));var a=new esri.geometry.Extent(-13576436,5955535,-13478597,6102294,new esri.SpatialReference({wkid:102100}));var f=new esri.geometry.Extent(-13674887,5637557,-13479208,5931075,new esri.SpatialReference({wkid:102100}));var l=new esri.geometry.Extent(-13497247,5986263,-13301569,6279781,new esri.SpatialReference({wkid:102100}));var c=new esri.geometry.Extent(-13542039,5827732,-13346361,6121250,new esri.SpatialReference({wkid:102100}));var h=new esri.geometry.Extent(-13537501,5846544,-13439662,5993303,new esri.SpatialReference({wkid:102100}));var p=new esri.geometry.Extent(-13569842,5648857,-13374163,5942375,new esri.SpatialReference({wkid:102100}));var d=[initExtent,t,n,r,i,s,o,a,u,f,l,c,h,p];map.setExtent(d[e]);$.mobile.changePage("#mapPage")}function changeTransparency(e){for(var t=0;t<dayLayerList.length;t++){dayLayerList[t].setOpacity(e/10)}}function toTitleCase(e){var t="";t=e.replace(/_/gi," ");return t.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function changeObs(e){addObType=e;graphic.setSymbol(getSymbol());e==="addObByClick"?$("#changeReportSlider").attr("data-theme","b"):$("#changeReportSlider").attr("data-theme","d");$("#changeReportSlider").slider("refresh");console.log("refreshed",$("#changeReportSlider").attr("data-theme"))}function changeSymbol(e,t,n){var r=new esri.symbol.SimpleMarkerSymbol;if(t==="highlight"){e.setSymbol(highlighted)}else if(t==="reset"){if(n==="obsLayer_layer"){r.setColor(new dojo.Color([0,153,255,.5]));e.setSymbol(r)}else if(n==="avyObsLayer_layer"){r.setColor(new dojo.Color([153,51,255,.5]));e.setSymbol(r)}}prevGraphic=e;prevObsLayer=n}function showAttributes(e){console.log("running showAttributes...");showGoToAttsDiv();var t=e.currentTarget.id;var n=e.graphic;!prevObsLayer?null:changeSymbol(prevGraphic,"reset",prevObsLayer);changeSymbol(n,"highlight",t);$("#obsAttsContent").children().empty();markup="";$.each(n.attributes,function(e,t){if(t!=null&&t!=""){if(e==="observer"){$.each(t,function(e,t){if(t!=null&&t!=""){if(e!=="id"&&e!=="resource_uri"){window[e+"VAR"]=t}else{}}else{window[e+"VAR"]=""}})}else if(e==="location"){$.each(t,function(e,t){if(t!=null&&t!=""){if(e==="region"){markup+="<li data-role='list-divider' data-theme='a'>"+t.zone_name+"</li>"}else{if(e!=="id"&&e!=="resource_uri"){window[e+"VAR"]=t}else{}}}else{window[e+"VAR"]=""}})}else{if(e!=="id"&&e!=="resource_uri"){if(e!=="id"&&e!=="resource_uri"){window[e+"VAR"]=t}else{}}else{}}}else{window[e+"VAR"]=""}});datetimeVAR!==""?addToMarkup("Date",datetimeVAR[5]+datetimeVAR[6]+"/"+datetimeVAR[8]+datetimeVAR[9]+"/"+datetimeVAR[0]+datetimeVAR[1]+datetimeVAR[2]+datetimeVAR[3]):null;first_nameVAR!==""?addToMarkup("Name",first_nameVAR+" "+last_nameVAR):null;latitudeVAR!==""?addToMarkup("Latitude",Number(latitudeVAR).toFixed(6)):null;longitudeVAR!==""?addToMarkup("Longitude",Number(longitudeVAR).toFixed(6)):null;elevationVAR!==""?addToMarkup("Elevation",elevationVAR+" "+elevation_unitsVAR):null;slope_angleVAR!==""?addToMarkup("Slope angle",slope_angleVAR+" degrees"):null;slope_aspectVAR!==""?addToMarkup("Slope aspect",slope_aspectVAR):null;descriptionVAR!==""?addToMarkup("Location description",descriptionVAR):null;if(t==="avyObsLayer_layer"){slide_typeVAR!==""?addToMarkup("Slide type",type_Lookup(slide_typeVAR)):null;causeVAR!==""?addToMarkup("Caused by",cause_lookup(causeVAR)):null;slide_widthVAR!==""?addToMarkup("Slide width",slide_widthVAR+" "+slide_width_unitsVAR):null;runout_lengthVAR!==""?addToMarkup("Vertical fall",runout_lengthVAR+" "+runout_length_unitsVAR):null;crown_depthVAR!==""?addToMarkup("Crown depth",crown_depthVAR+" "+crown_depth_unitsVAR):null;weak_layerVAR!==""?weakLayer_lookup("Weak layer",weak_layerVAR):null;bed_surfaceVAR!==""?addToMarkup("Bed surface",bedSurface_lookup(bed_surfaceVAR)):null;number_caughtVAR!==""?addToMarkup("Number caught",number_caughtVAR):null;number_carriedVAR!==""?addToMarkup("Number carried",number_carriedVAR):null;number_buriedVAR!==""?addToMarkup("Number buried",number_buriedVAR):null;number_partially_buriedVAR!==""?addToMarkup("Number partially buried",number_partially_buriedVAR):null;number_injuredVAR!==""?addToMarkup("Number injured",number_injuredVAR):null;number_killedVAR!==""?addToMarkup("Number killed",number_killedVAR):null;avalanche_size_destructive_forceVAR!==""?addToMarkup("Size/Destructive force",sizeDF_lookup(avalanche_size_destructive_forceVAR)):null;avalanche_size_relativeVAR!==""?addToMarkup("Size relative to path",sizeRelative_lookup(avalanche_size_relativeVAR)):null}else if(t==="obsLayer_layer"){air_tempVAR!==""?addToMarkup("Air temperature",air_tempVAR+air_tempVAR):null;cloud_coverVAR!==""?addToMarkup("Cloud cover",cloud_coverVAR):null;precipitation_typeVAR!==""?addToMarkup("Precipitation type",precipitation_typeVAR):null;precipitation_intensityVAR!==""?addToMarkup("Precipitation intensity",precipitation_intensityVAR):null;wind_directionVAR!==""?addToMarkup("Wind direction",wind_directionVAR):null;wind_speedVAR!==""?addToMarkup("Wind speed",wind_speedVAR):null;rapid_warmingVAR!==""?addToMarkup("Rapid warming?",TF_lookup(rapid_warmingVAR)):null;recent_avalanchesVAR!==""?addToMarkup("Recent avalanches?",TF_lookup(recent_avalanchesVAR)):null;recent_loadingVAR!==""?addToMarkup("Recent loading",TF_lookup(recent_loadingVAR)):null;shooting_cracksVAR!==""?addToMarkup("Shooting cracks",TF_lookup(shooting_cracksVAR)):null;signs_of_collapseVAR!==""?addToMarkup("Signs of collapse?",TF_lookup(signs_of_collapseVAR)):null;terrain_trapsVAR!==""?addToMarkup("Terrain traps",TF_lookup(terrain_trapsVAR)):null;weather_commentsVAR!==""?addToMarkup("Snowpack comments",weather_commentsVAR):null;snowpack_commentsVAR!==""?addToMarkup("Snowpack comments",snowpack_commentsVAR):null;observation_commentsVAR!==""?addToMarkup("Observation comments",observation_commentsVAR):null;snowpit_profile_imageVAR!==""?addImgLinkToMarkup("Snowpit profile image",snowpit_profile_imageVAR):null;snowpit_profile_image_urlVAR!==""?addToMarkup("Snowpit profile image URLR",snowpit_profile_image_urlVAR):null;mediaVAR!==""?addImgLinkToMarkup("Photo",mediaVAR):null}getStabTest(n,t)}function makePage(e,t){$("#obsAtts").html(markup);$("#obsAtts").listview("refresh");$("#obsAttsPage").page();$("#hideGoToAttsDivButton").bind("click",function(n){changeSymbol(e,"reset",t);hideGoToAttsDiv()})}function addImgLinkToMarkup(e,t){markup+="<li data-role='list-divider'>"+e+'</li><li><a href="'+t+'"target="_blank" />View photo in new window</li>';return markup}function addToMarkup(e,t){markup+="<li data-role='list-divider'>"+e+"</li><li><p>"+t+"</p></li>";return markup}function TF_lookup(e){console.log(e);var t;e==="true"||e==="on"||e===true?t="Yes":t="No";return t}function sizeDF_lookup(e){var t;if(e=="D1"){t="(D1) Relatively harmless to people"}else if(e=="D2"){t="(D2) Could bury, injure, or kill a person."}else if(e=="D3"){t="(D3) Could bury and destroy a car, damage a truck, destroy a wood frame house, or break a few trees."}else if(e=="D4"){t="(D4) Could destroy a railway car, large truck, several buildings, or a substantial amount of forest."}else if(e=="D5"){t="(D5) Could gouge the landscape. Largest snow avalanche known."}return t}function sizeRelative_lookup(e){var t;if(e=="R1"){t="(R1) Very small, relative to the path."}else if(e=="R2"){t="(R2) Small, relative to the path."}else if(e=="R3"){t="(R3) Medium, relative to the path."}else if(e=="R4"){t="(R4) Large, relative to the path."}else if(e=="R5"){t="(R5) Major or maximum, relative to the path."}return t}function weakLayer_lookup(e){var t;if(e=="PP"){t="Precipitation Particles (New Snow)"}else if(e=="MM"){t="Machine Made snow"}else if(e=="DF"){t="Decomposing and Fragmented Particles"}else if(e=="RG"){t="Rounded Grains"}else if(e=="FC"){t="Faceted Crystals"}else if(e=="DH"){t="Depth Hoar"}else if(e=="SH"){t="Surface Hoar"}else if(e=="MF"){t="Melt Forms"}else if(e=="IF"){t="Ice Formations"}return t}function bedSurface_lookup(e){var t;if(e=="S"){t="The avalanche released within a layer of recent storm snow."}else if(e=="I"){t="The avalanche released at the new snow/old snow interface."}else if(e=="O"){t="The avalanche released within the old snow."}else if(e=="G"){t="The avalanche released at the ground, glacial ice or firn."}else if(e=="U"){t="Unknown"}return t}function type_Lookup(e){var t;if(e=="L"){t="Loose-snow avalanche"}else if(e==="WL"){t="Wet loose-snow avalanche"}else if(e==="SS"){t="Soft slab avalanche"}else if(e==="HS"){t="Hard slab avalanche"}else if(e==="WS"){t="Wet slab avalanche"}else if(e==="I"){t="Ice fall or avalanche"}else if(e==="SF"){t="Slush flow"}else if(e==="C"){t="Cornice fall (w/o additional avalanche)"}else if(e==="R"){t="Roof avalanche"}else if(e==="U"){t="Unknown"}return t}function cause_lookup(e){var t;if(e=="AS"){t="Skier"}else if(e=="AR"){t="Snowboarder"}else if(e=="AI"){t="Snowshoer"}else if(e=="AM"){t="Snowmobile"}else if(e=="AB"){t="An explosive detonated above the snow surface (air blast)"}else if(e=="AO"){t="Unclassified artificial trigger (specify in comments)"}else if(e=="AU"){t="Unknown artificial trigger"}else if(e=="N"){t="Natural trigger"}else if(e=="NC"){t="Cornice fall"}else if(e=="NE"){t="Earthquake"}else if(e=="NI"){t="Ice fall"}else if(e=="AF"){t="Foot penetration"}else if(e=="AE"){t="An explosive thrown or placed on or under the snow surface by hand"}else if(e=="NL"){t="Avalanche triggered by loose snow avalanche"}else if(e=="NS"){t="Avalanche triggered by slab avalanche"}else if(e=="NR"){t="Rock fall"}else if(e=="NO"){t="Unclassified natural trigger (specify in comments)"}else if(e=="AA"){t="Artillery"}else if(e=="AL"){t="Avalauncher"}else if(e=="AC"){t="Cornice fall triggered by human or explosive action"}else if(e=="AX"){t="Gas exploder"}else if(e=="AH"){t="Explosives placed via helicopter"}else if(e=="AP"){t="Pre-placed, remotely detonated explosive charge"}else if(e=="AW"){t="Wildlife"}else if(e=="AK"){t="Snowcat"}else if(e=="AV"){t="Vehicle (specify vehicle type in comments)"}return t}function showGoToAttsDiv(){$("#goToAttsDiv").css({visibility:"visible",display:"block"});hideAskFillOutForm()}function hideGoToAttsDiv(){$("#goToAttsDiv").css({visibility:"hidden",display:"none"})}function askFillOutForm(){$("#askObsFormDiv").css({visibility:"visible",display:"block"});$("#askObsFormDivButton").bind("click",function(e){if(addObType==="addObByClick"||addObType==="addObByGeoLoc"){$.mobile.changePage("#obsReport");!$("#obs_Date").val()?setDate("#obs_Date"):null}else{$.mobile.changePage("#avyReport");!$("#avy_Date").val()?setDate("#avy_Date"):null}});!prevObsLayer?null:changeSymbol(prevGraphic,"reset",prevObsLayer);hideGoToAttsDiv()}function askAddStabTest(){$("#askAddStabTestDiv").css({visibility:"visible",display:"block"})}function hideAskAddStabTestDiv(){$("#askAddStabTestDiv").css({visibility:"hidden",display:"none"});$("#stabTestDivLabel").html("Add stability test with observation?")}function hideAskFillOutForm(){$("#askObsFormDiv").css({visibility:"hidden",display:"none"});map.graphics.hide();addObType=null}function updateGraphicHandles(){console.log(addGraphicHandle);!addGraphicHandle?null:removeAddGraphicHandles();!obsGotten?null:showObsAttsHandle=dojo.connect(map.getLayer("obsLayer"),"onClick",showAttributes);!avyObsGotten?null:showAvyObsAttsHandle=dojo.connect(map.getLayer("avObsLayer"),"onClick",showAttributes)}function buildRegionQuery(){dojo.connect(map,"onClick",getRegion);queryTask=new esri.tasks.QueryTask("http://140.160.114.190/ArcGIS/rest/services/NWAC/RegionsBoth/MapServer/0");dojo.connect(queryTask,"onError",noRegion);query=new esri.tasks.Query;query.spatialRelationship=esri.tasks.Query.SPATIAL_REL_INTERSECTS;query.returnGeometry=true;query.outFields=["name","region_num"];query.outSpatialReference={wkid:102100}}function noRegion(e){console.log("not in a region - selecting region 1 for now, until there is a 14/other avalailable");zone=1}function getRegion(e){query.geometry=e.mapPoint;queryTask.execute(query,function(t){var n=JSON.stringify(t,null,2);var r=$.parseJSON(n);if(!r.features[0]){console.log("no region");noRegion("filler")}else{var i=r.features[0].attributes.name;var s=r.features[0].attributes.region_num;zone=s;console.log(i,s,zone,regions[zone])}})}function upDatePoint(e,t){var n=esri.geometry.geographicToWebMercator(new esri.geometry.Point(t,e));graphic.setGeometry(n)}dojo.require("esri.map");dojo.require("esri.tasks.locator");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("esri.dijit.Gallery");dojo.require("esri.dijit.BasemapGallery");dojo.require("dijit.Menu");dojo.require("dijit.form.Slider");dojo.require("esri.tasks.query");dojo.require("esri.tasks.geometry");dojo.require("esri.arcgis.utils");dojo.require("esri.utils");dojo.addOnLoad(onDOMLoad);var map;var gallery;var basemaps;var locator;var watchId;var markup;var graphic=null;var type;var obsGotten=false;var avyObsGotten=false;var addObType;var prevFromDate,prevToDate;var datesChanged=false;var proxyUrl;var queryTask,query,loading;var symbol,infoTemplate,popupRose;var day1Layer;var day2Layer;var day3Layer;var day4Layer;var day5Layer;var day6Layer;var day7Layer;var day8Layer;var day9Layer;var day10Layer;var RegionsBoth;var query,queryTask;var initExtent;var dayLayerList;var dateList=[];var reversedDateListForSlider=[];var addLayer,startLayer,lastLayerAdded;var dayChangerArray=[];var selectedDay;var day1RoseList=[];var day2RoseList=[];var day3RoseList=[];var day4RoseList=[];var day5RoseList=[];var day6RoseList=[];var day7RoseList=[];var day8RoseList=[];var day9RoseList=[];var day10RoseList=[];var dayRoseListArray=[day1RoseList,day2RoseList,day3RoseList,day4RoseList,day5RoseList,day6RoseList,day7RoseList,day8RoseList,day9RoseList,day10RoseList];var day1Rose,day2Rose,day3Rose,day4Rose,day5Rose,day6Rose,day7Rose,day8Rose,day9Rose,day10Rose;var roseList=[day1Rose,day2Rose,day3Rose,day4Rose,day5Rose,day6Rose,day7Rose,day8Rose,day9Rose,day10Rose];var ONE_DAY=1e3*60*60*24;var todayVar=new Date;var today=formatDate(todayVar,"display");var checkZoom;var showObsAttsHandle,showAvyObsAttsHandle;var addGraphicHandle;var currentLocSymbol;var avyObsSymbol;var obsSymbol;var highlighted;var prevObsLayer=null;var prevGraphic=null;var lastObsAdded;var regions=["Olympics","Cascade West Pass-Stevens Pass","Cascade West Pass-Snoq. Pass","Cascade West Pass - White Pass","Cascade West-Stevens Pass N","Cascade West-Stev to Snoq","Cascade West-Snoq to White",">Cascade West - White Pass","Cascade East - Stevens Pass","Cascade East-Stevens to Snoq","Cascade East-Snoq to White","Cascade East - White Pass S","Mt Hood"];var zone